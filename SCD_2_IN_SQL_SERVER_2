CREATE TABLE [dbo].[dimMaterial]
(
[Material] [varchar](18) NOT NULL Primary Key,
[CreatedOn] [date] NULL,
[LastChange] [date] NULL,
[MaterialType] [varchar](4) NULL,
[MaterialTypeDescription] [varchar](25) NULL,
[IndustrySector] [varchar](1) NULL,
[MaterialGroup] [varchar](9) NULL,
[MaterialGroupDescription] [varchar](20) NULL,
[OldMaterialNumber] [varchar](18) NULL,
[BaseUOM] [varchar](3) NULL,
[Size] [varchar](32) NULL,
[Lab/Office] [varchar](3) NULL,
[GrossWeight] [decimal](18, 2) NULL,
[NetWeight] [decimal](18, 2) NULL,
[WeightUnit] [varchar](3) NULL,
[Volume] [decimal](18, 2) NULL,
[VolumeUnit] [varchar](3) NULL,
[Division] [varchar](2) NULL,
[MaterialDescription] [varchar](40) NULL,
[PlantStatus] [varchar](2) NULL,
[DistributionStatus] [varchar](2) NULL,
[2AHValue] [decimal](5, 0) NULL,
[C20Value] [decimal](5, 0) NULL,
[PUValue] [decimal](5, 0) NULL,
[Brand] [varchar](18) NULL,
[BrandDescription] [varchar](40) NULL,
[Segment] [varchar](9) NULL,
[activeflag] [bit] NULL,
[ValidFrom] [date] NULL,
[ValidTo] [date] NULL,
[PriorityProduct] [varchar](2) NULL,
DimensionCheckSum int not null 
    constraint dim_material default -1
	)


CREATE TABLE [dbo].[SCD_1]
(
SurrogateKey int not null identity(1,1),
[Material] [varchar](18) NOT NULL Primary Key,
[CreatedOn] [date] NULL,
[LastChange] [date] NULL,
[MaterialType] [varchar](4) NULL,
[MaterialTypeDescription] [varchar](25) NULL,
[IndustrySector] [varchar](1) NULL,
[MaterialGroup] [varchar](9) NULL,
[MaterialGroupDescription] [varchar](20) NULL,
[OldMaterialNumber] [varchar](18) NULL,
[BaseUOM] [varchar](3) NULL,
[Size] [varchar](32) NULL,
[Lab/Office] [varchar](3) NULL,
[GrossWeight] [decimal](18, 2) NULL,
[NetWeight] [decimal](18, 2) NULL,
[WeightUnit] [varchar](3) NULL,
[Volume] [decimal](18, 2) NULL,
[VolumeUnit] [varchar](3) NULL,
[Division] [varchar](2) NULL,
[MaterialDescription] [varchar](40) NULL,
[PlantStatus] [varchar](2) NULL,
[DistributionStatus] [varchar](2) NULL,
[2AHValue] [decimal](5, 0) NULL,
[C20Value] [decimal](5, 0) NULL,
[PUValue] [decimal](5, 0) NULL,
[Brand] [varchar](18) NULL,
[BrandDescription] [varchar](40) NULL,
[Segment] [varchar](9) NULL,
[activeflag] [bit] NULL,
[ValidFrom] [date] NULL,
[ValidTo] [date] NULL,
[PriorityProduct] [varchar](2) NULL,
DimensionCheckSum int not null 
    constraint dim_scd default -1

	)


update [dbo].[dimMaterial] set DimensionCheckSum=
BINARY_CHECKSUM(
[Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum)


select * from [dbo].[dimMaterial]
select * from [dbo].[SCD_1]


insert into[dbo].[SCD_1]
( --Table and columns in which to insert the data
 
[Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum
)
select    

[Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum

from
(
  -- This is the beginning of the merge statement.
  -- The target must be defined, in this example it is our slowly changing
  -- dimension table
  MERGE into [dbo].[SCD_1] AS target
  -- The source must be defined with the USING clause
  USING 
  (
  select 

  [Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum
from 
[dbo].[dimMaterial]
)
as source 
(
  [Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum
) ON
(
target.Material = source.Material)
WHEN MATCHED and target.DimensionCheckSum <> source.DimensionCheckSum 
                                 and target.[activeflag]='Y'

then update set 
activeflag = 'N'

 WHEN NOT MATCHED THEN  
  INSERT 
  (
  [Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum
  )
  VALUES 
  (
Source.[Material] ,
Source.[CreatedOn],
Source.[LastChange],
Source.[MaterialType] ,
Source.[MaterialTypeDescription] ,
Source.[IndustrySector],
Source.[MaterialGroup] ,
Source.[MaterialGroupDescription] ,
Source.[OldMaterialNumber] ,
Source.[BaseUOM],
Source.[Size] ,
Source.[Lab/Office] ,
Source.[GrossWeight] ,
Source.[NetWeight] ,
Source.[WeightUnit],
Source.[Volume],
Source.[VolumeUnit],
Source.[Division] ,
Source.[MaterialDescription],
Source.[PlantStatus],
Source.[DistributionStatus],
Source.[2AHValue],
Source.[C20Value] ,
Source.[PUValue] ,
Source.[Brand] ,
Source.[BrandDescription],
Source.[Segment],
Source.[activeflag],
Source.[ValidFrom],
Source.[ValidTo],
Source.[PriorityProduct],
Source.DimensionCheckSum
  )
    OUTPUT $action, 
 Source.[Material] ,
Source.[CreatedOn],
Source.[LastChange],
Source.[MaterialType] ,
Source.[MaterialTypeDescription] ,
Source.[IndustrySector],
Source.[MaterialGroup] ,
Source.[MaterialGroupDescription] ,
Source.[OldMaterialNumber] ,
Source.[BaseUOM],
Source.[Size] ,
Source.[Lab/Office] ,
Source.[GrossWeight] ,
Source.[NetWeight] ,
Source.[WeightUnit],
Source.[Volume],
Source.[VolumeUnit],
Source.[Division] ,
Source.[MaterialDescription],
Source.[PlantStatus],
Source.[DistributionStatus],
Source.[2AHValue],
Source.[C20Value] ,
Source.[PUValue] ,
Source.[Brand] ,
Source.[BrandDescription],
Source.[Segment],
Source.[activeflag],
Source.[ValidFrom],
Source.[ValidTo],
Source.[PriorityProduct],
Source.DimensionCheckSum
)
as changes
(
action,
 [Material] ,
[CreatedOn],
[LastChange],
[MaterialType] ,
[MaterialTypeDescription] ,
[IndustrySector],
[MaterialGroup] ,
[MaterialGroupDescription] ,
[OldMaterialNumber] ,
[BaseUOM],
[Size] ,
[Lab/Office] ,
[GrossWeight] ,
[NetWeight] ,
[WeightUnit],
[Volume],
[VolumeUnit],
[Division] ,
[MaterialDescription],
[PlantStatus],
[DistributionStatus],
[2AHValue],
[C20Value] ,
[PUValue] ,
[Brand] ,
[BrandDescription],
[Segment],
[activeflag],
[ValidFrom],
[ValidTo],
[PriorityProduct],
DimensionCheckSum
)
where action = 'UPDATE';
